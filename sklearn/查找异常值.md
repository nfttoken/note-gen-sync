## pandas 或sklearn 自动查找异常值的函数

1、使用 Pandas 寻找异常值

* 方法 1：基于 IQR（四分位距）

IQR 方法是一种常用的统计方法，用于检测异常值。异常值通常定义为低于 **Q1 - 1.5\*IQR** 或高于 **Q3 + 1.5\*IQR** 的值。

```
import pandas as pd
import numpy as np

# 示例数据
data = pd.DataFrame({
    'value': [1, 2, 3, 4, 5, 100, -50, 6, 7, 8]
})

# 定义函数以检测异常值
def find_outliers_iqr(series):
    Q1 = series.quantile(0.25)
    Q3 = series.quantile(0.75)
    IQR = Q3 - Q1
    lower_bound = Q1 - 1.5 * IQR
    upper_bound = Q3 + 1.5 * IQR
    outliers = series[(series < lower_bound) | (series > upper_bound)]
    return outliers

# 检测异常值
outliers = find_outliers_iqr(data['value'])
print("Outliers using IQR:\n", outliers)
```

**输出示例**:

```
Outliers using IQR:
 5    100
 6    -50
Name: value, dtype: int64
```

* 方法 2：基于 Z 分数（标准差）

Z 分数方法检测偏离均值超过一定标准差（通常为 3）的值作为异常值。

```
# 定义函数以检测基于 Z 分数的异常值
def find_outliers_zscore(series, threshold=3):
    z_scores = np.abs((series - series.mean()) / series.std())
    outliers = series[z_scores > threshold]
    return outliers

# 检测异常值
outliers_zscore = find_outliers_zscore(data['value'], threshold=3)
print("Outliers using Z-score:\n", outliers_zscore)
```

**输出示例**:

```
Outliers using Z-score:
 5    100
 6    -50
Name: value, dtype: int64
```

2. **使用 Scikit-learn 寻找异常值**

Scikit-learn 提供了一些专门的机器学习算法来检测异常值，适用于更高维或复杂的数据集。

* 方法 1：Isolation Forest（孤立森林）

Isolation Forest 是一种基于树的算法，适合高维数据，假设异常值更容易被隔离。

```
from sklearn.ensemble import IsolationForest
import pandas as pd

# 示例数据
data = pd.DataFrame({
    'feature1': [1, 2, 3, 4, 5, 100, -50, 6, 7, 8],
    'feature2': [2, 4, 6, 8, 10, 200, -100, 12, 14, 16]
})

# 使用 Isolation Forest 检测异常值
iso_forest = IsolationForest(contamination=0.2, random_state=42)  # contamination 设置异常值比例
outlier_labels = iso_forest.fit_predict(data)

# 异常值为 -1，正常值为 1
outliers = data[outlier_labels == -1]
print("Outliers using Isolation Forest:\n", outliers)
```

**输出示例**:

```
Outliers using Isolation Forest:
    feature1  feature2
5      100      200
6      -50     -100
```

* **3、可视化**：结合箱线图、散点图或直方图可以直观验证异常值。
* 标准化+隔离森林+可视化 的示例代码：

```
import pandas as pd
import numpy as np
from sklearn.ensemble import IsolationForest
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler

# 示例数据
data = pd.DataFrame({
    'feature1': [1, 2, 3, 4, 5, 100, -50, 6, 7, 8],
    'feature2': [2, 4, 6, 8, 10, 200, -100, 12, 14, 16]
})

# 标准化数据
scaler = StandardScaler()
data_scaled = scaler.fit_transform(data)
data_scaled = pd.DataFrame(data_scaled, columns=data.columns)

# 使用 Isolation Forest 检测异常值
iso_forest = IsolationForest(contamination=0.2, random_state=42)
outlier_labels = iso_forest.fit_predict(data_scaled)

# 可视化
plt.scatter(data['feature1'], data['feature2'], c=outlier_labels, cmap='coolwarm')
plt.title('Outlier Detection with Isolation Forest')
plt.xlabel('Feature 1')
plt.ylabel('Feature 2')
plt.show()

# 输出异常值
outliers = data[outlier_labels == -1]
print("Outliers:\n", outliers)
```
